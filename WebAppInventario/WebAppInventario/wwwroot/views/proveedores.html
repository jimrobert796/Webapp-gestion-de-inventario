<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Proveedores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .contenedor {
            display: flex;
            gap: 20px;
        }

        .formulario {
            flex: 1;
        }

        .tabla-proveedores {
            flex: 2;
            max-height: 500px;
            overflow-y: auto;
        }

        .botones-crud {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .tabla-desactivada {
            pointer-events: none;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <h2 class="mb-3">Gestión de Proveedores</h2>

        <div class="contenedor">
            <!-- Formulario lado izquierdo -->
            <div class="formulario">
                <form id="formProveedor">
                    <input type="hidden" id="idProveedor">
                    <div class="mb-2">
                        <input type="text" class="form-control" id="nombre" placeholder="Nombre" required disabled>
                    </div>
                    <div class="mb-2">
                        <input type="tel" class="form-control" id="telefono" placeholder="Teléfono" required disabled>
                    </div>
                    <div class="mb-2">
                        <input type="email" class="form-control" id="email" placeholder="Email" required disabled>
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="direccion" placeholder="Dirección" required disabled>
                    </div>
                </form>
            </div>

            <!-- Tabla lado derecho información de proveedor -->
            <div class="tabla-proveedores">
                <table class="table table-dark table-striped" id="tablaProveedores">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Email</th>
                            <th>Dirección</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Datos de proveedores -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Botones CRUD debajo de la tabla -->
        <div class="botones-crud">
            <button id="btnAgregar" class="btn btn-primary">Agregar</button>
            <button id="btnEditar" class="btn btn-warning">Editar</button>
            <button id="btnEliminar" class="btn btn-danger">Eliminar</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        (function () {
            let proveedores = [];
            let filaSeleccionada = null;
            let modo = 'normal'; // Estados: 'normal', 'agregar', 'editar'

            function renderTabla() {
                let tbody = $("#tablaProveedores tbody");
                tbody.empty();
                proveedores.forEach((prov, i) => {
                    tbody.append(`
                                    <tr data-index="${i}">
                                        <td>${prov.nombre}</td>
                                        <td>${prov.telefono}</td>
                                        <td>${prov.email}</td>
                                        <td>${prov.direccion}</td>
                                    </tr>
                                `);
                });

                // Solo agregar el evento click si estamos en modo normal
                if (modo === 'normal') {
                    $("#tablaProveedores tbody tr").click(function () {
                        $("#tablaProveedores tbody tr").removeClass("table-primary");
                        $(this).addClass("table-primary");
                        filaSeleccionada = $(this).data("index");

                        // Llenar formulario
                        let prov = proveedores[filaSeleccionada];
                        $("#idProveedor").val(prov.idProveedor);
                        $("#nombre").val(prov.nombre);
                        $("#telefono").val(prov.telefono);
                        $("#email").val(prov.email);
                        $("#direccion").val(prov.direccion);
                    });
                }
            }

            function cargarProveedores() {
                $.ajax({
                    url: "/api/Proveedores",
                    method: "GET",
                    success: function (data) {
                        proveedores = data.map(prov => ({
                            idProveedor: prov.idProveedor,
                            nombre: prov.nombre.trim(),
                            telefono: prov.telefono.trim(),
                            email: prov.email.trim(),
                            direccion: prov.direccion.trim(),
                            estado: prov.estado
                        }));
                        renderTabla();
                    },
                    error: function (err) {
                        console.error("Error cargando proveedores:", err);
                    }
                });
            }

            function activarModoAgregar() {
                modo = 'agregar';
                $("#btnAgregar").text("Guardar").removeClass("btn-primary").addClass("btn-success");
                $("#btnEditar").text("Cancelar").removeClass("btn-warning").addClass("btn-secondary");
                $("#btnEliminar").prop("disabled", true);
                $("#tablaProveedores").addClass("tabla-desactivada");
                $("#formProveedor")[0].reset();
                filaSeleccionada = null;
                // Habilitar campos del formulario
                $("#nombre, #telefono, #email, #direccion").prop("disabled", false);
                renderTabla(); // Re-render para quitar eventos de click
            }

            function activarModoEditar() {
                if (filaSeleccionada === null) {
                    alert("Seleccione un proveedor para editar");
                    return;
                }
                modo = 'editar';
                $("#btnAgregar").text("Guardar Cambios").removeClass("btn-primary").addClass("btn-success");
                $("#btnEditar").text("Cancelar").removeClass("btn-warning").addClass("btn-secondary");
                $("#btnEliminar").prop("disabled", true);
                $("#tablaProveedores").addClass("tabla-desactivada");
                // Habilitar campos del formulario
                $("#nombre, #telefono, #email, #direccion").prop("disabled", false);
                renderTabla(); // Re-render para quitar eventos de click
            }

            function desactivarModo() {
                modo = 'normal';
                $("#btnAgregar").text("Agregar").removeClass("btn-success").addClass("btn-primary");
                $("#btnEditar").text("Editar").removeClass("btn-secondary").addClass("btn-warning");
                $("#btnEliminar").prop("disabled", false);
                $("#tablaProveedores").removeClass("tabla-desactivada");
                $("#formProveedor")[0].reset();
                filaSeleccionada = null;
                // Deshabilitar campos del formulario
                $("#nombre, #telefono, #email, #direccion").prop("disabled", true);
                renderTabla(); // Re-render para restaurar eventos
            }

            $(document).ready(function () {
                cargarProveedores();

                // Botón Agregar / Guardar
                $("#btnAgregar").click(function () {
                    if (modo === 'agregar') {
                        // Guardar nuevo proveedor
                        if (!$("#formProveedor")[0].checkValidity()) {
                            $("#formProveedor")[0].reportValidity();
                            return;
                        }
                        let nuevo = {
                            idProveedor: 0,
                            nombre: $("#nombre").val(),
                            telefono: $("#telefono").val(),
                            email: $("#email").val(),
                            direccion: $("#direccion").val(),
                            estado: true
                        };
                        $.ajax({
                            url: "/api/Proveedores",
                            method: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(nuevo),
                            success: function () {
                                alert("Proveedor agregado");
                                cargarProveedores();
                                desactivarModo();
                            },
                            error: function (err) { console.error(err); }
                        });
                    } else if (modo === 'editar') {
                        // Guardar cambios en edición
                        if (!$("#formProveedor")[0].checkValidity()) {
                            $("#formProveedor")[0].reportValidity();
                            return;
                        }
                        let actualizar = {
                            idProveedor: Number($("#idProveedor").val()),
                            nombre: $("#nombre").val(),
                            telefono: $("#telefono").val(),
                            email: $("#email").val(),
                            direccion: $("#direccion").val(),
                            estado: true
                        };
                        $.ajax({
                            url: `/api/Proveedores/${actualizar.idProveedor}`,
                            method: "PUT",
                            contentType: "application/json",
                            data: JSON.stringify(actualizar),
                            success: function () {
                                alert("Proveedor actualizado");
                                cargarProveedores();
                                desactivarModo();
                            },
                            error: function (err) { console.error(err); }
                        });
                    } else {
                        // Inicia modo agregar
                        activarModoAgregar();
                    }
                });

                // Botón Editar / Cancelar
                $("#btnEditar").click(function () {
                    if (modo === 'agregar' || modo === 'editar') {
                        // Cancelar
                        desactivarModo();
                    } else {
                        // Inicia modo editar
                        activarModoEditar();
                    }
                });

                // Eliminar proveedor
                $("#btnEliminar").click(function () {
                    if (modo !== 'normal') return; // Deshabilitado en modos agregar/editar
                    if (filaSeleccionada === null) {
                        alert("Seleccione un proveedor para eliminar");
                        return;
                    }
                    let id = Number($("#idProveedor").val());
                    const nombreProveedor = $("#nombre").val();
                    if (confirm(`¿Desea eliminar a ${nombreProveedor}?`)) {
                        $.ajax({
                            url: `/api/Proveedores/${id}`,
                            method: "DELETE",
                            success: function () {
                                alert("Proveedor eliminado");
                                cargarProveedores();
                                $("#formProveedor")[0].reset();
                                filaSeleccionada = null;
                            },
                            error: function (err) { console.error(err); }
                        });
                    }
                });
            });
        })();
    </script>
</body>
</html>
