<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Proveedores</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Estilos personalizados para scroll interno en la tabla -->
    <style>
        .table-scroll {
            max-height: 400px; /* Altura máxima de la tabla (ajusta según necesites) */
            overflow-y: auto; /* Scroll vertical interno */
        }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container mt-4">
        <!-- Tarjeta principal -->
        <div class="card shadow">
            <!-- Encabezado de la tarjeta -->
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">Gestión de Proveedores</h2>
            </div>

            <!-- Cuerpo de la tarjeta -->
            <div class="card-body">
                <!-- Botones de acción y búsqueda en una fila -->
                <div class="row mb-3 align-items-center">
                    <!-- Botones CRUD al lado izquierdo -->
                    <div class="col-md-6">
                        <button id="btnNuevo" class="btn btn-primary">Nuevo Proveedor</button>
                        <button id="btnEditar" class="btn btn-warning" disabled>Editar</button>
                        <button id="btnEliminar" class="btn btn-danger" disabled>Eliminar</button>
                    </div>

                    <!-- Buscador al lado derecho -->
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-primary text-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="inputBuscar" placeholder="Buscar por nombre...">
                            <button class="btn btn-outline-secondary" type="button" id="btnLimpiarBusqueda" title="Limpiar búsqueda">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de proveedores con scroll responsive e interno -->
                <div class="table-responsive table-scroll">
                    <!-- Agrega 'table-scroll' para scroll interno -->
                    <table class="table table-striped table-hover" id="tablaProveedores">
                        <thead class="table-dark">
                            <tr>
                                <th>Nombre</th>
                                <th>Teléfono</th>
                                <th>Email</th>
                                <th>Dirección</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos de proveedores se cargan dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- ========== MODAL PARA AGREGAR/EDITAR PROVEEDOR ========== -->
    <div class="modal fade" id="modalProveedor" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Encabezado del modal -->
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitulo">
                        <i class="bi bi-building"></i> Nuevo Proveedor
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <!-- Cuerpo del modal con todo visible -->
                <div class="modal-body">
                    <form id="formProveedor">
                        <!-- Campo oculto para el ID del proveedor (solo se usa al editar) -->
                        <input type="hidden" id="idProveedor">

                        <!-- Sección Información del Proveedor -->
                        <div class="border rounded p-3">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-shop"></i> Información del Proveedor
                            </h6>

                            <!-- Fila: Nombre y Teléfono -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="nombre" class="form-label">
                                        <i class="bi bi-building"></i> Nombre del Proveedor
                                    </label>
                                    <input type="text" class="form-control" id="nombre" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="telefono" class="form-label">
                                        <i class="bi bi-telephone"></i> Teléfono
                                    </label>
                                    <input type="tel" class="form-control" id="telefono" required>
                                </div>
                            </div>

                            <!-- Fila: Email y Dirección -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">
                                        <i class="bi bi-envelope"></i> Email
                                    </label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="direccion" class="form-label">
                                        <i class="bi bi-geo-alt"></i> Dirección
                                    </label>
                                    <input type="text" class="form-control" id="direccion" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Pie del modal con botones -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnGuardar">
                        <i class="bi bi-check-circle"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- ========== MODAL DE CONFIRMACIÓN DE ELIMINACIÓN ========== -->
    <div class="modal fade" id="modalEliminar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje de confirmación con nombre del proveedor -->
                    <p class="mb-0">¿Desea eliminar al proveedor <strong id="nombreProveedorEliminar"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Sí, Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL DE ÉXITO ========== -->
    <div class="modal fade" id="modalExito" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Éxito</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje dinámico de éxito (se cambia desde JavaScript) -->
                    <p class="mb-0" id="mensajeExito"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL DE ERROR ========== -->
    <div class="modal fade" id="modalError" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Error</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje dinámico de error (se cambia desde JavaScript) -->
                    <p class="mb-0" id="mensajeError"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== JAVASCRIPT PRINCIPAL ========== -->
    <script>
        // IIFE (Immediately Invoked Function Expression) para encapsular el código
        (function () {
            // ========== VARIABLES GLOBALES ==========
            let proveedoresFiltrados = [];   // Array para almacenar proveedores filtrados desde la API
            let filaSeleccionada = null;     // Índice de la fila seleccionada en la tabla
            let modoEdicion = false;         // Bandera para saber si estamos editando o agregando
            let modalProveedor;              // Instancia del modal de proveedor
            let debounceTimer;               // Timer para debounce en búsqueda

            // ========== FUNCIÓN PARA BUSCAR PROVEEDORES DESDE LA API ==========
            function buscarProveedores(textoBusqueda = '') {
                // Limpiar timer anterior para debounce
                clearTimeout(debounceTimer);
                // Esperar 300ms antes de hacer la llamada (evita llamadas excesivas)
                debounceTimer = setTimeout(() => {
                    $.ajax({
                        url: `/api/Proveedores/buscar?buscar=${encodeURIComponent(textoBusqueda)}`,  // Endpoint de búsqueda
                        method: "GET",
                        success: function (data) {
                            // Mapear los datos recibidos al formato que usamos
                            proveedoresFiltrados = data.map(prov => ({
                                idProveedor: prov.idProveedor,
                                nombre: prov.nombre.trim(),
                                telefono: prov.telefono.trim(),
                                email: prov.email.trim(),
                                direccion: prov.direccion.trim(),
                                estado: prov.estado
                            }));
                            renderTabla(); // Actualizar la tabla con los datos filtrados
                            // Resetear selección al buscar
                            filaSeleccionada = null;
                            $("#btnEditar, #btnEliminar").prop("disabled", true);
                        },
                        error: function (err) {
                            console.error("Error buscando proveedores:", err);
                            // Mostrar modal de error
                            $("#mensajeError").text("Error al buscar proveedores. Intente nuevamente.");
                            let modalError = new bootstrap.Modal(document.getElementById('modalError'));
                            modalError.show();
                        }
                    });
                }, 300);  // Debounce de 300ms
            }

            // ========== FUNCIÓN PARA RENDERIZAR LA TABLA ==========
            function renderTabla() {
                let tbody = $("#tablaProveedores tbody");
                tbody.empty(); // Limpiar el contenido actual de la tabla

                // Si no hay proveedores, mostrar mensaje
                if (proveedoresFiltrados.length === 0) {
                    let mensaje = "No se encontraron proveedores con ese criterio de búsqueda";
                    tbody.append(`
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                ${mensaje}
                                            </td>
                                        </tr>
                                    `);
                    return;
                }

                // Recorrer el array de proveedores y crear filas
                proveedoresFiltrados.forEach((prov, i) => {
                    tbody.append(`
                                        <tr data-index="${i}">
                                            <td>${prov.nombre}</td>
                                            <td>${prov.telefono}</td>
                                            <td>${prov.email}</td>
                                            <td>${prov.direccion}</td>
                                        </tr>
                                    `);
                });

                // Agregar evento click a cada fila de la tabla
                $("#tablaProveedores tbody tr").click(function () {
                    // No hacer nada si es la fila de "no hay proveedores"
                    if ($(this).find('td').length === 1) return;

                    // Remover la clase de selección de todas las filas
                    $("#tablaProveedores tbody tr").removeClass("table-primary");
                    // Agregar clase de selección a la fila clickeada
                    $(this).addClass("table-primary");
                    // Guardar el índice de la fila seleccionada
                    filaSeleccionada = $(this).data("index");

                    // Habilitar los botones de Editar y Eliminar
                    $("#btnEditar, #btnEliminar").prop("disabled", false);
                });
            }

            // ========== FUNCIÓN PARA CARGAR PROVEEDORES DESDE LA API (PARA INICIALIZACIÓN) ==========
            function cargarProveedores() {
                buscarProveedores('');  // Inicializar búsqueda vacía (mostrar todos)
            }

            // ========== FUNCIÓN PARA LIMPIAR EL FORMULARIO ==========
            function limpiarFormulario() {
                $("#formProveedor")[0].reset();  // Reset del formulario HTML
                $("#idProveedor").val("");       // Limpiar el ID oculto
            }

            // ========== FUNCIÓN PARA ABRIR MODAL EN MODO "NUEVO" ==========
            function abrirModalNuevo() {
                modoEdicion = false;  // Indicar que estamos agregando
                limpiarFormulario();  // Limpiar el formulario
                // Configurar el título y botón para "Nuevo"
                $("#modalTitulo").text("Nuevo Proveedor");
                $("#btnGuardar").text("Guardar").removeClass("btn-warning").addClass("btn-primary");
                modalProveedor.show();  // Mostrar el modal
            }

            // ========== FUNCIÓN PARA ABRIR MODAL EN MODO "EDITAR" ==========
            function abrirModalEditar() {
                // Validar que hay una fila seleccionada
                if (filaSeleccionada === null) {
                    alert("Seleccione un proveedor para editar");
                    return;
                }

                modoEdicion = true;  // Indicar que estamos editando
                let prov = proveedoresFiltrados[filaSeleccionada];  // Obtener datos del proveedor filtrado

                // Llenar el formulario con los datos del proveedor
                $("#idProveedor").val(prov.idProveedor);
                $("#nombre").val(prov.nombre);
                $("#telefono").val(prov.telefono);
                $("#email").val(prov.email);
                $("#direccion").val(prov.direccion);

                // Configurar el título y botón para "Editar"
                $("#modalTitulo").text("Editar Proveedor");
                $("#btnGuardar").text("Guardar Cambios").removeClass("btn-primary").addClass("btn-warning");
                modalProveedor.show();  // Mostrar el modal
            }

            // ========== FUNCIÓN PARA GUARDAR PROVEEDOR (AGREGAR O EDITAR) ==========
            function guardarProveedor() {
                // Validar que el formulario esté completo
                if (!$("#formProveedor")[0].checkValidity()) {
                    $("#formProveedor")[0].reportValidity();
                    return;
                }

                // Recopilar datos del formulario
                let datos = {
                    nombre: $("#nombre").val(),
                    telefono: $("#telefono").val(),
                    email: $("#email").val(),
                    direccion: $("#direccion").val(),
                    estado: true
                };

                // ===== MODO EDICIÓN (PUT) =====
                if (modoEdicion) {
                    datos.idProveedor = Number($("#idProveedor").val());
                    $.ajax({
                        url: `/api/Proveedores/${datos.idProveedor}`,
                        method: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify(datos),
                        success: function () {
                            modalProveedor.hide();  // Ocultar modal del formulario
                            // Mostrar modal de éxito
                            $("#mensajeExito").text("El proveedor fue actualizado exitosamente.");
                            let modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
                            modalExito.show();
                            // Recargar datos y resetear selección
                            buscarProveedores($("#inputBuscar").val());  // Recargar con la búsqueda actual
                            filaSeleccionada = null;
                            $("#btnEditar, #btnEliminar").prop("disabled", true);
                        },
                        error: function (err) {
                            console.error(err);
                            modalProveedor.hide();  // Ocultar modal del formulario
                            // Mostrar modal de error
                            $("#mensajeError").text("No se pudo actualizar el proveedor. Por favor, intente nuevamente.");
                            let modalError = new bootstrap.Modal(document.getElementById('modalError'));
                            modalError.show();
                        }
                    });
                }
                // ===== MODO AGREGAR (POST) =====
                else {
                    datos.idProveedor = 0;  // ID 0 para nuevo registro
                    $.ajax({
                        url: "/api/Proveedores",
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(datos),
                        success: function () {
                            modalProveedor.hide();  // Ocultar modal del formulario
                            // Mostrar modal de éxito
                            $("#mensajeExito").text("El proveedor fue agregado exitosamente.");
                            let modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
                            modalExito.show();
                            // Recargar datos
                            buscarProveedores($("#inputBuscar").val());  // Recargar con la búsqueda actual
                        },
                        error: function (err) {
                            console.error(err);
                            modalProveedor.hide();  // Ocultar modal del formulario
                            // Mostrar modal de error
                            $("#mensajeError").text("No se pudo agregar el proveedor. Por favor, intente nuevamente.");
                            let modalError = new bootstrap.Modal(document.getElementById('modalError'));
                            modalError.show();
                        }
                    });
                }
            }

            // ========== FUNCIÓN PARA MOSTRAR MODAL DE CONFIRMACIÓN DE ELIMINACIÓN ==========
            function eliminarProveedor() {
                // Validar que hay una fila seleccionada
                if (filaSeleccionada === null) {
                    alert("Seleccione un proveedor para eliminar");
                    return;
                }

                // Validar que hay una fila seleccionada
                if (filaSeleccionada === null) {
                    alert("Seleccione un proveedor para eliminar");
                    return;
                }

                let prov = proveedoresFiltrados[filaSeleccionada];

                // Mostrar el nombre del proveedor en el modal de confirmación
                $("#nombreProveedorEliminar").text(prov.nombre);
                let modalEliminar = new bootstrap.Modal(document.getElementById('modalEliminar'));
                modalEliminar.show();
            }

            // ========== FUNCIÓN PARA CONFIRMAR Y EJECUTAR LA ELIMINACIÓN ==========
            function confirmarEliminacion() {
                let prov = proveedoresFiltrados[filaSeleccionada];
                let modalEliminar = bootstrap.Modal.getInstance(document.getElementById('modalEliminar'));

                // Llamada DELETE a la API
                $.ajax({
                    url: `/api/Proveedores/${prov.idProveedor}`,
                    method: "DELETE",
                    success: function () {
                        modalEliminar.hide();  // Ocultar modal de confirmación
                        // Mostrar modal de éxito
                        $("#mensajeExito").text("El proveedor fue eliminado exitosamente.");
                        let modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
                        modalExito.show();
                        // Recargar datos y resetear selección
                        buscarProveedores($("#inputBuscar").val());  // Recargar con la búsqueda actual
                        filaSeleccionada = null;
                        $("#btnEditar, #btnEliminar").prop("disabled", true);
                    },
                    error: function (err) {
                        console.error(err);
                        modalEliminar.hide();  // Ocultar modal de confirmación
                        // Mostrar modal de error
                        $("#mensajeError").text("No se pudo eliminar el proveedor. Por favor, intente nuevamente.");
                        let modalError = new bootstrap.Modal(document.getElementById('modalError'));
                        modalError.show();
                    }
                });
            }

            // ========== INICIALIZACIÓN CUANDO EL DOCUMENTO ESTÁ LISTO ==========
            $(document).ready(function () {
                // Crear instancia del modal de proveedor
                modalProveedor = new bootstrap.Modal(document.getElementById('modalProveedor'));

                // Cargar proveedores al iniciar
                cargarProveedores();

                // ===== ASIGNAR EVENTOS A LOS BOTONES =====
                $("#btnNuevo").click(abrirModalNuevo);                    // Botón "Nuevo Proveedor"
                $("#btnEditar").click(abrirModalEditar);                  // Botón "Editar"
                $("#btnEliminar").click(eliminarProveedor);               // Botón "Eliminar"
                $("#btnGuardar").click(guardarProveedor);                 // Botón "Guardar" en el modal
                $("#btnConfirmarEliminar").click(confirmarEliminacion);   // Botón "Sí, Eliminar"

                // ===== LIMPIAR FORMULARIO AL CERRAR EL MODAL =====
                $('#modalProveedor').on('hidden.bs.modal', function () {
                    limpiarFormulario();
                });

                // ===== BÚSQUEDA EN TIEMPO REAL CON DEBOUNCE =====
                $("#inputBuscar").on("input", function () {
                    let textoBusqueda = $(this).val();
                    buscarProveedores(textoBusqueda);
                });

                // ===== LIMPIAR BÚSQUEDA =====
                $("#btnLimpiarBusqueda").click(function () {
                    $("#inputBuscar").val("");
                    buscarProveedores("");  // Limpiar búsqueda
                    // Resetear selección
                    filaSeleccionada = null;
                    $("#btnEditar, #btnEliminar").prop("disabled", true);
                });
            });
        })();
    </script>
</body>
</html>
