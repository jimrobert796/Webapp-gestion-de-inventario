<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Empleados</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .table-scroll {
            max-height: 300px; /* Altura máxima de la tabla (ajusta según necesites, ej. 500px para más filas) */
            overflow-y: auto; /* Scroll vertical interno */
        }
    </style>

</head>
<body>
    <!-- Contenedor principal -->
    <div class="container mt-4">
        <!-- Tarjeta principal -->
        <div class="card shadow">
            <!-- Encabezado de la tarjeta -->
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">Gestión de Empleados</h2>
            </div>

            <!-- Cuerpo de la tarjeta -->
            <div class="card-body">
                <!-- Botones de acción y búsqueda en una fila -->
                <div class="row mb-3 align-items-center">
                    <!-- Botones CRUD al lado izquierdo -->
                    <div class="col-md-6">
                        <button id="btnNuevo" class="btn btn-primary">Nuevo Empleado</button>
                        <button id="btnEditar" class="btn btn-warning" disabled>Editar</button>
                        <button id="btnEliminar" class="btn btn-danger" disabled>Eliminar</button>
                    </div>

                    <!-- Buscador al lado derecho -->
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-primary text-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="inputBuscar" placeholder="Buscar por nombre o credencial...">
                            <button class="btn btn-outline-secondary" type="button" id="btnLimpiarBusqueda" title="Limpiar búsqueda">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de empleados con scroll responsive -->
                <div class="table-responsive table-scroll">
                    <table class="table table-striped table-hover" id="tablaEmpleados">
                        <thead class="table-dark">
                            <tr>
                                <th>Rol</th>
                                <th>Nombre</th>
                                <th>Credencial</th>
                                <th>Teléfono</th>
                                <th>Email</th>
                                <th>Dirección</th>
                                <th>Fecha Nac.</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos de empleados se cargan dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL PARA AGREGAR/EDITAR EMPLEADO ========== -->
    <div class="modal fade" id="modalEmpleado" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Encabezado del modal -->
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitulo">Nuevo Empleado</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <!-- Cuerpo del modal con formulario -->
                <div class="modal-body">
                    <form id="formEmpleado">
                        <!-- Campo oculto para el ID del empleado (solo se usa al editar) -->
                        <input type="hidden" id="idEmpleado">

                        <!-- Primera fila: Rol y Nombre -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="rol" class="form-label">Rol</label>
                                <select id="rol" class="form-select" required>
                                    <option value="">Seleccione un rol</option>
                                    <option value="1">Administrador</option>
                                    <option value="2">Bodega</option>
                                    <option value="3">Cajero</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="nombre" class="form-label">Nombre Completo</label>
                                <input type="text" class="form-control" id="nombre" required>
                            </div>
                        </div>

                        <!-- Segunda fila: Credencial y Contraseña -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="credencial" class="form-label">Credencial</label>
                                <input type="text" class="form-control" id="credencial" required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="contrasena" class="form-label">Contraseña</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="contrasena" required>
                                    <!-- Botón para mostrar/ocultar contraseña -->
                                    <button class="btn btn-outline-secondary" type="button" id="btnTogglePassword">
                                        <i class="bi bi-eye" id="iconoPassword"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tercera fila: Teléfono y Email -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="telefono" required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                        </div>

                        <!-- Cuarta fila: Dirección y Fecha de Nacimiento -->
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="direccion" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="direccion" required>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="fechaNacimiento" class="form-label">Fecha Nacimiento</label>
                                <input type="date" class="form-control" id="fechaNacimiento" required>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Pie del modal con botones -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL DE CONFIRMACIÓN DE ELIMINACIÓN ========== -->
    <div class="modal fade" id="modalEliminar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje de confirmación con nombre del empleado -->
                    <p class="mb-0">¿Desea eliminar al empleado <strong id="nombreEmpleadoEliminar"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Sí, Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL DE ÉXITO ========== -->
    <div class="modal fade" id="modalExito" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Éxito</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje dinámico de éxito (se cambia desde JavaScript) -->
                    <p class="mb-0" id="mensajeExito"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL DE ERROR ========== -->
    <div class="modal fade" id="modalError" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Error</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje dinámico de error (se cambia desde JavaScript) -->
                    <p class="mb-0" id="mensajeError"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== JAVASCRIPT PRINCIPAL ========== -->
    <script>
        // IIFE (Immediately Invoked Function Expression) para encapsular el código
        (function () {
            // ========== VARIABLES GLOBALES ==========
            let empleadosFiltrados = [];     // Array para almacenar empleados filtrados desde la API
            let filaSeleccionada = null;     // Índice de la fila seleccionada en la tabla
            let modoEdicion = false;         // Bandera para saber si estamos editando o agregando
            let modalEmpleado;               // Instancia del modal de empleado
            let debounceTimer;               // Timer para debounce en búsqueda

            // ========== FUNCIÓN PARA BUSCAR EMPLEADOS DESDE LA API ==========
            function buscarEmpleados(textoBusqueda = '') {
                // Limpiar timer anterior para debounce
                clearTimeout(debounceTimer);
                // Esperar 300ms antes de hacer la llamada (evita llamadas excesivas)
                debounceTimer = setTimeout(() => {
                    $.ajax({
                        url: `/api/Empleados/buscar?buscar=${encodeURIComponent(textoBusqueda)}`,  // Endpoint de búsqueda
                        method: "GET",
                        success: function (data) {
                            // Mapear los datos recibidos al formato que usamos
                            empleadosFiltrados = data.map(emp => ({
                                idEmpleado: emp.idEmpleado,
                                idRol: emp.idRol,
                                rolNombre: emp.rol.trim(),
                                nombre: emp.nombre.trim(),
                                credencial: emp.credencial.trim(),
                                contrasena: emp.contraseña.trim(),
                                telefono: emp.telefono.trim(),
                                email: emp.email.trim(),
                                direccion: emp.direccion.trim(),
                                fechaNacimiento: emp.fechaNacimiento
                            }));
                            renderTabla(); // Actualizar la tabla con los datos filtrados
                            // Resetear selección al buscar
                            filaSeleccionada = null;
                            $("#btnEditar, #btnEliminar").prop("disabled", true);
                        },
                        error: function (err) {
                            console.error("Error buscando empleados:", err);
                            // Mostrar modal de error
                            $("#mensajeError").text("Error al buscar empleados. Intente nuevamente.");
                            let modalError = new bootstrap.Modal(document.getElementById('modalError'));
                            modalError.show();
                        }
                    });
                }, 300);  // Debounce de 300ms
            }

            // ========== FUNCIÓN PARA RENDERIZAR LA TABLA ==========
            function renderTabla() {
                let tbody = $("#tablaEmpleados tbody");
                tbody.empty(); // Limpiar el contenido actual de la tabla

                // Si no hay empleados, mostrar mensaje
                if (empleadosFiltrados.length === 0) {
                    let mensaje = "No se encontraron empleados con ese criterio de búsqueda";
                    tbody.append(`
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            ${mensaje}
                                        </td>
                                    </tr>
                                `);
                    return;
                }

                // Recorrer el array de empleados y crear filas
                empleadosFiltrados.forEach((emp, i) => {
                    tbody.append(`
                                    <tr data-index="${i}">
                                        <td>${emp.rolNombre}</td>
                                        <td>${emp.nombre}</td>
                                        <td>${emp.credencial}</td>
                                        <td>${emp.telefono}</td>
                                        <td>${emp.email}</td>
                                        <td>${emp.direccion}</td>
                                        <td>${emp.fechaNacimiento}</td>
                                    </tr>
                                `);
                });

                // Agregar evento click a cada fila de la tabla
                $("#tablaEmpleados tbody tr").click(function () {
                    // No hacer nada si es la fila de "no hay empleados"
                    if ($(this).find('td').length === 1) return;

                    // Remover la clase de selección de todas las filas
                    $("#tablaEmpleados tbody tr").removeClass("table-primary");
                    // Agregar clase de selección a la fila clickeada
                    $(this).addClass("table-primary");
                    // Guardar el índice de la fila seleccionada
                    filaSeleccionada = $(this).data("index");

                    // Habilitar los botones de Editar y Eliminar
                    $("#btnEditar, #btnEliminar").prop("disabled", false);
                });
            }

            // ========== FUNCIÓN PARA CARGAR EMPLEADOS DESDE LA API (PARA INICIALIZACIÓN) ==========
            function cargarEmpleados() {
                buscarEmpleados('');  // Inicializar búsqueda vacía (mostrar todos)
            }

            // ========== FUNCIÓN PARA LIMPIAR EL FORMULARIO ==========
            function limpiarFormulario() {
                $("#formEmpleado")[0].reset();  // Reset del formulario HTML
                $("#idEmpleado").val("");       // Limpiar el ID oculto
            }

            // ========== FUNCIÓN PARA ABRIR MODAL EN MODO "NUEVO" ==========
            function abrirModalNuevo() {
                modoEdicion = false;  // Indicar que estamos agregando
                limpiarFormulario();  // Limpiar el formulario
                // Configurar el título y botón para "Nuevo"
                $("#modalTitulo").text("Nuevo Empleado");
                $("#btnGuardar").text("Guardar").removeClass("btn-warning").addClass("btn-primary");
                modalEmpleado.show();  // Mostrar el modal
            }

            // ========== FUNCIÓN PARA ABRIR MODAL EN MODO "EDITAR" ==========
            function abrirModalEditar() {
                // Validar que hay una fila seleccionada
                if (filaSeleccionada === null) {
                    alert("Seleccione un empleado para editar");
                    return;
                }

                modoEdicion = true;  // Indicar que estamos editando
                let emp = empleadosFiltrados[filaSeleccionada];  // Obtener datos del empleado filtrado

                // Llenar el formulario con los datos del empleado
                $("#idEmpleado").val(emp.idEmpleado);
                $("#rol").val(emp.idRol);
                $("#nombre").val(emp.nombre);
                $("#credencial").val(emp.credencial);
                $("#contrasena").val(emp.contrasena);
                $("#telefono").val(emp.telefono);
                $("#email").val(emp.email);
                $("#direccion").val(emp.direccion);
                $("#fechaNacimiento").val(emp.fechaNacimiento);

                // Configurar el título y botón para "Editar"
                $("#modalTitulo").text("Editar Empleado");
                $("#btnGuardar").text("Guardar Cambios").removeClass("btn-primary").addClass("btn-warning");
                modalEmpleado.show();  // Mostrar el modal
            }

            // ========== FUNCIÓN PARA GUARDAR EMPLEADO (AGREGAR O EDITAR) ==========
            function guardarEmpleado() {
                // Validar que el formulario esté completo
                if (!$("#formEmpleado")[0].checkValidity()) {
                    $("#formEmpleado")[0].reportValidity();
                    return;
                }

                // Recopilar datos del formulario
                let datos = {
                    idRol: Number($("#rol").val()),
                    nombre: $("#nombre").val(),
                    credencial: $("#credencial").val(),
                    contraseña: $("#contrasena").val(),
                    telefono: $("#telefono").val(),
                    email: $("#email").val(),
                    direccion: $("#direccion").val(),
                    fechaNacimiento: $("#fechaNacimiento").val(),
                    estado: true
                };

                // ===== MODO EDICIÓN (PUT) =====
                if (modoEdicion) {
                    datos.idEmpleado = Number($("#idEmpleado").val());
                    $.ajax({
                        url: `/api/Empleados/${datos.idEmpleado}`,
                        method: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify(datos),
                            success: function () {
                            modalEmpleado.hide();  // Ocultar modal del formulario
                            // Mostrar modal de éxito
                            $("#mensajeExito").text("El empleado fue actualizado exitosamente.");
                            let modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
                            modalExito.show();
                            // Recargar datos y resetear selección
                            buscarEmpleados($("#inputBuscar").val());  // Recargar con la búsqueda actual
                            filaSeleccionada = null;
                            $("#btnEditar, #btnEliminar").prop("disabled", true);
                        },
                            error: function (err) {
                                console.error(err);
                                modalEmpleado.hide();  // Ocultar modal del formulario
                                // Mostrar modal de error
                                $("#mensajeError").text("No se pudo actualizar el empleado. Por favor, intente nuevamente.");
                                let modalError = new bootstrap.Modal(document.getElementById('modalError'));
                                modalError.show();
                            }
                        });
                }
                // ===== MODO AGREGAR (POST) =====
                else {
                    $.ajax({
                        url: "/api/Empleados",
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(datos),
                        success: function () {
                            modalEmpleado.hide();  // Ocultar modal del formulario
                            // Mostrar modal de éxito
                            $("#mensajeExito").text("El empleado fue agregado exitosamente.");
                            let modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
                            modalExito.show();
                            // Recargar datos
                            buscarEmpleados($("#inputBuscar").val());  // Recargar con la búsqueda actual
                        },
                        error: function (err) {
                            console.error(err);
                            modalEmpleado.hide();  // Ocultar modal del formulario
                            // Mostrar modal de error
                            $("#mensajeError").text("No se pudo agregar el empleado. Por favor, intente nuevamente.");
                            let modalError = new bootstrap.Modal(document.getElementById('modalError'));
                            modalError.show();
                        }
                    });
                }
            }

            // ========== FUNCIÓN PARA MOSTRAR MODAL DE CONFIRMACIÓN DE ELIMINACIÓN ==========
            function eliminarEmpleado() {
                // Validar que hay una fila seleccionada
                if (filaSeleccionada === null) {
                    alert("Seleccione un empleado para eliminar");
                    return;
                }

                let emp = empleadosFiltrados[filaSeleccionada];

                // Mostrar el nombre del empleado en el modal de confirmación
                $("#nombreEmpleadoEliminar").text(emp.nombre);
                let modalEliminar = new bootstrap.Modal(document.getElementById('modalEliminar'));
                modalEliminar.show();
            }

            // ========== FUNCIÓN PARA CONFIRMAR Y EJECUTAR LA ELIMINACIÓN ==========
            function confirmarEliminacion() {
                let emp = empleadosFiltrados[filaSeleccionada];
                let modalEliminar = bootstrap.Modal.getInstance(document.getElementById('modalEliminar'));

                // Llamada DELETE a la API
                $.ajax({
                    url: `/api/Empleados/${emp.idEmpleado}`,
                    method: "DELETE",
                    success: function () {
                        modalEliminar.hide();  // Ocultar modal de confirmación
                        // Mostrar modal de éxito
                        $("#mensajeExito").text("El empleado fue eliminado exitosamente.");
                        let modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
                        modalExito.show();
                        // Recargar datos y resetear selección
                        buscarEmpleados($("#inputBuscar").val());  // Recargar con la búsqueda actual
                        filaSeleccionada = null;
                        $("#btnEditar, #btnEliminar").prop("disabled", true);
                    },
                    error: function (err) {
                        console.error(err);
                        modalEliminar.hide();  // Ocultar modal de confirmación
                        // Mostrar modal de error
                        $("#mensajeError").text("No se pudo eliminar el empleado. Por favor, intente nuevamente.");
                        let modalError = new bootstrap.Modal(document.getElementById('modalError'));
                        modalError.show();
                    }
                });
            }

            // ========== INICIALIZACIÓN CUANDO EL DOCUMENTO ESTÁ LISTO ==========
            $(document).ready(function () {
                // Crear instancia del modal de empleado
                modalEmpleado = new bootstrap.Modal(document.getElementById('modalEmpleado'));

                // Cargar empleados al iniciar
                cargarEmpleados();

                // ===== ASIGNAR EVENTOS A LOS BOTONES =====
                $("#btnNuevo").click(abrirModalNuevo);                    // Botón "Nuevo Empleado"
                $("#btnEditar").click(abrirModalEditar);                  // Botón "Editar"
                $("#btnEliminar").click(eliminarEmpleado);                // Botón "Eliminar"
                $("#btnGuardar").click(guardarEmpleado);                  // Botón "Guardar" en el modal
                $("#btnConfirmarEliminar").click(confirmarEliminacion);   // Botón "Sí, Eliminar"

                // ===== TOGGLE PARA MOSTRAR/OCULTAR CONTRASEÑA =====
                $("#btnTogglePassword").click(function () {
                    let input = $("#contrasena");
                    let icono = $("#iconoPassword");

                    // Cambiar tipo de input entre password y text
                    if (input.attr("type") === "password") {
                        input.attr("type", "text");    // Mostrar contraseña
                        icono.removeClass("bi-eye").addClass("bi-eye-slash");  // Cambiar a ojo tachado
                    } else {
                        input.attr("type", "password"); // Ocultar contraseña
                        icono.removeClass("bi-eye-slash").addClass("bi-eye");  // Cambiar a ojo normal
                    }
                });

                // ===== LIMPIAR FORMULARIO AL CERRAR EL MODAL =====
                $('#modalEmpleado').on('hidden.bs.modal', function () {
                    limpiarFormulario();
                });

                // ===== BÚSQUEDA EN TIEMPO REAL CON DEBOUNCE =====
                $("#inputBuscar").on("input", function () {
                    let textoBusqueda = $(this).val();
                    buscarEmpleados(textoBusqueda);
                });

                // ===== LIMPIAR BÚSQUEDA =====
                $("#btnLimpiarBusqueda").click(function () {
                    $("#inputBuscar").val("");
                    buscarEmpleados("");  // Limpiar búsqueda
                    // Resetear selección
                    filaSeleccionada = null;
                    $("#btnEditar, #btnEliminar").prop("disabled", true);
                });
            });
        })();
    </script>
</body>
</html>