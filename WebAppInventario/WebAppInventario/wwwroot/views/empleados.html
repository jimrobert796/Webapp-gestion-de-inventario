<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Empleados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .contenedor {
            display: flex;
            gap: 20px;
        }

        .formulario {
            flex: 1;
        }

        .tabla-empleados {
            flex: 2;
            max-height: 500px;
            overflow-y: auto;
        }

        .botones-crud {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end; /* Cambiado a flex-end para alinear a la derecha */
            gap: 10px;
        }

        .tabla-desactivada {
            pointer-events: none;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <h2 class="mb-3">Gestión de Empleados</h2>

        <div class="contenedor">
            <!-- Formulario lado izquierdo -->
            <div class="formulario">
                <form id="formEmpleado">
                    <input type="hidden" id="idEmpleado">
                    <input type="hidden" id="idRol">
                    <div class="mb-2">
                        <label for="rol" class="form-label">Rol</label>
                        <select id="rol" class="form-select" required disabled>
                            <option value="">Seleccione un rol</option>
                            <option value="1">Administrador</option>
                            <option value="2">Bodega</option>
                            <option value="3">Cajero</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="nombre" placeholder="Nombre" required disabled>
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="credencial" placeholder="Credencial" required disabled>
                    </div>
                    <div class="mb-2">
                        <input type="password" class="form-control" id="contrasena" placeholder="Contraseña" required disabled>
                    </div>
                    <div class="mb-2">
                        <input type="tel" class="form-control" id="telefono" placeholder="Teléfono" required disabled>
                    </div>
                    <div class="mb-2">
                        <input type="email" class="form-control" id="email" placeholder="Email" required disabled>
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="direccion" placeholder="Dirección" required disabled>
                    </div>
                    <div class="mb-2">
                        <input type="date" class="form-control" id="fechaNacimiento" placeholder="Fecha de Nacimiento" required disabled>
                    </div>
                </form>
            </div>

            <!-- Tabla lado derecho informacion de empleado -->
            <div class="tabla-empleados">
                <table class="table table-dark table-striped" id="tablaEmpleados">
                    <thead>
                        <tr>
                            <th>Rol</th>
                            <th>Nombre</th>
                            <th>Credencial</th>
                            <th>Teléfono</th>
                            <th>Email</th>
                            <th>Dirección</th>
                            <th>Fecha Nac.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Datos de empleados completos -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Botones CRUD debajo de la tabla segun las ventanas -->
        <div class="botones-crud">
            <button id="btnAgregar" class="btn btn-primary">Agregar</button>
            <button id="btnEditar" class="btn btn-warning">Editar</button>
            <button id="btnEliminar" class="btn btn-danger">Eliminar</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        (function () {
            let empleados = [];
            let filaSeleccionada = null;
            let modo = 'normal'; // Estados: 'normal', 'agregar', 'editar'

            function renderTabla() {
                let tbody = $("#tablaEmpleados tbody");
                tbody.empty();
                empleados.forEach((emp, i) => {
                    tbody.append(`
                                    <tr data-index="${i}">
                                        <td>${emp.rolNombre}</td>
                                        <td>${emp.nombre}</td>
                                        <td>${emp.credencial}</td>
                                        <td>${emp.telefono}</td>
                                        <td>${emp.email}</td>
                                        <td>${emp.direccion}</td>
                                        <td>${emp.fechaNacimiento}</td>
                                    </tr>
                                `);
                });

                // Solo agregar el evento click si estamos en modo normal
                if (modo === 'normal') {
                    $("#tablaEmpleados tbody tr").click(function () {
                        $("#tablaEmpleados tbody tr").removeClass("table-primary");
                        $(this).addClass("table-primary");
                        filaSeleccionada = $(this).data("index");

                        // Llenar formulario
                        let emp = empleados[filaSeleccionada];
                        $("#idEmpleado").val(emp.idEmpleado);
                        $("#idRol").val(emp.idRol);
                        $("#rol").val(emp.idRol);
                        $("#nombre").val(emp.nombre);
                        $("#credencial").val(emp.credencial);
                        $("#contrasena").val(emp.contrasena);
                        $("#telefono").val(emp.telefono);
                        $("#email").val(emp.email);
                        $("#direccion").val(emp.direccion);
                        $("#fechaNacimiento").val(emp.fechaNacimiento);
                    });
                }
            }

            function cargarEmpleados() {
                $.ajax({
                    url: "/api/Empleados",
                    method: "GET",
                    success: function (data) {
                        empleados = data.map(emp => ({
                            idEmpleado: emp.idEmpleado,
                            idRol: emp.idRol,
                            rolNombre: emp.rol.trim(),
                            nombre: emp.nombre.trim(),
                            credencial: emp.credencial.trim(),
                            contrasena: emp.contraseña.trim(),
                            telefono: emp.telefono.trim(),
                            email: emp.email.trim(),
                            direccion: emp.direccion.trim(),
                            fechaNacimiento: emp.fechaNacimiento
                        }));
                        renderTabla();
                    },
                    error: function (err) {
                        console.error("Error cargando empleados:", err);
                    }
                });
            }

            function activarModoAgregar() {
                modo = 'agregar';
                $("#btnAgregar").text("Guardar").removeClass("btn-primary").addClass("btn-success");
                $("#btnEditar").text("Cancelar").removeClass("btn-warning").addClass("btn-secondary");
                $("#btnEliminar").prop("disabled", true);
                $("#tablaEmpleados").addClass("tabla-desactivada");
                $("#formEmpleado")[0].reset();
                filaSeleccionada = null;
                // Habilitar campos del formulario
                $("#rol, #nombre, #credencial, #contrasena, #telefono, #email, #direccion, #fechaNacimiento").prop("disabled", false);
                renderTabla(); // Re-render para quitar eventos de click
            }

            function activarModoEditar() {
                if (filaSeleccionada === null) {
                    alert("Seleccione un empleado para editar");
                    return;
                }
                modo = 'editar';
                $("#btnAgregar").text("Guardar Cambios").removeClass("btn-primary").addClass("btn-success");
                $("#btnEditar").text("Cancelar").removeClass("btn-warning").addClass("btn-secondary");
                $("#btnEliminar").prop("disabled", true);
                $("#tablaEmpleados").addClass("tabla-desactivada");
                // Habilitar campos del formulario
                $("#rol, #nombre, #credencial, #contrasena, #telefono, #email, #direccion, #fechaNacimiento").prop("disabled", false);
                renderTabla(); // Re-render para quitar eventos de click
            }

            function desactivarModo() {
                modo = 'normal';
                $("#btnAgregar").text("Agregar").removeClass("btn-success").addClass("btn-primary");
                $("#btnEditar").text("Editar").removeClass("btn-secondary").addClass("btn-warning");
                $("#btnEliminar").prop("disabled", false);
                $("#tablaEmpleados").removeClass("tabla-desactivada");
                $("#formEmpleado")[0].reset();
                filaSeleccionada = null;
                // Deshabilitar campos del formulario
                $("#rol, #nombre, #credencial, #contrasena, #telefono, #email, #direccion, #fechaNacimiento").prop("disabled", true);
                renderTabla(); // Re-render para restaurar eventos
            }

            $(document).ready(function () {
                cargarEmpleados();

                // Botón Agregar / Guardar
                $("#btnAgregar").click(function () {
                    if (modo === 'agregar') {
                        // Guardar nuevo empleado
                        if (!$("#formEmpleado")[0].checkValidity()) {
                            $("#formEmpleado")[0].reportValidity();
                            return;
                        }
                        let nuevo = {
                            idRol: Number($("#rol").val()),
                            nombre: $("#nombre").val(),
                            credencial: $("#credencial").val(),
                            contraseña: $("#contrasena").val(),
                            telefono: $("#telefono").val(),
                            email: $("#email").val(),
                            direccion: $("#direccion").val(),
                            fechaNacimiento: $("#fechaNacimiento").val(),
                            estado: true
                        };
                        $.ajax({
                            url: "/api/Empleados",
                            method: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(nuevo),
                            success: function () {
                                alert("Empleado agregado");
                                cargarEmpleados();
                                desactivarModo();
                            },
                            error: function (err) { console.error(err); }
                        });
                    } else if (modo === 'editar') {
                        // Guardar cambios en edición
                        if (!$("#formEmpleado")[0].checkValidity()) {
                            $("#formEmpleado")[0].reportValidity();
                            return;
                        }
                        let actualizar = {
                            idEmpleado: Number($("#idEmpleado").val()),
                            idRol: Number($("#rol").val()),
                            nombre: $("#nombre").val(),
                            credencial: $("#credencial").val(),
                            contraseña: $("#contrasena").val(),
                            telefono: $("#telefono").val(),
                            email: $("#email").val(),
                            direccion: $("#direccion").val(),
                            fechaNacimiento: $("#fechaNacimiento").val(),
                            estado: true
                        };
                        $.ajax({
                            url: `/api/Empleados/${actualizar.idEmpleado}`,
                            method: "PUT",
                            contentType: "application/json",
                            data: JSON.stringify(actualizar),
                            success: function () {
                                alert("Empleado actualizado");
                                cargarEmpleados();
                                desactivarModo();
                            },
                            error: function (err) { console.error(err); }
                        });
                    } else {
                        // Inicia modo agregar
                        activarModoAgregar();
                    }
                });

                // Botón Editar / Cancelar
                $("#btnEditar").click(function () {
                    if (modo === 'agregar' || modo === 'editar') {
                        // Cancelar
                        desactivarModo();
                    } else {
                        // Inicia modo editar
                        activarModoEditar();
                    }
                });

                // Eliminar empleado
                $("#btnEliminar").click(function () {
                    if (modo !== 'normal') return; // Deshabilitado en modos agregar/editar
                    if (filaSeleccionada === null) {
                        alert("Seleccione un empleado para eliminar");
                        return;
                    }
                    let id = Number($("#idEmpleado").val());
                    const nombreEmpleado = $("#nombre").val();
                    if (confirm(`¿Desea eliminar a ${nombreEmpleado}?`)) {
                        $.ajax({
                            url: `/api/Empleados/${id}`,
                            method: "DELETE",
                            success: function () {
                                alert("Empleado eliminado");
                                cargarEmpleados();
                                $("#formEmpleado")[0].reset();
                                filaSeleccionada = null;
                            },
                            error: function (err) { console.error(err); }
                        });
                    }
                });
            });
        })();
    </script>
</body>
</html>
