<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Clientes</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container mt-4">
        <!-- Tarjeta principal -->
        <div class="card shadow">
            <!-- Encabezado de la tarjeta -->
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">Gestión de Clientes</h2>
            </div>

            <!-- Cuerpo de la tarjeta -->
            <div class="card-body">
                <!-- Botones de acción y búsqueda en una fila -->
                <div class="row mb-3 align-items-center">
                    <!-- Botones CRUD al lado izquierdo -->
                    <div class="col-md-6">
                        <button id="btnNuevo" class="btn btn-primary">Nuevo Cliente</button>
                        <button id="btnEditar" class="btn btn-warning" disabled>Editar</button>
                        <button id="btnEliminar" class="btn btn-danger" disabled>Eliminar</button>
                    </div>

                    <!-- Buscador al lado derecho -->
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-primary text-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="inputBuscar" placeholder="Buscar por nombre...">
                            <button class="btn btn-outline-secondary" type="button" id="btnLimpiarBusqueda" title="Limpiar búsqueda">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de clientes con scroll responsive -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tablaClientes">
                        <thead class="table-dark">
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Dirección</th>
                                <th>Teléfono</th>
                                <th>Fecha Creación</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos de clientes se cargan dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL PARA AGREGAR/EDITAR CLIENTE ========== -->
    <div class="modal fade" id="modalCliente" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Encabezado del modal -->
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitulo">Nuevo Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <!-- Cuerpo del modal con formulario -->
                <div class="modal-body">
                    <form id="formCliente">
                        <!-- Campo oculto para el ID del cliente (solo se usa al editar) -->
                        <input type="hidden" id="idCliente">

                        <!-- Campo Nombre -->
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre del Cliente</label>
                            <input type="text" class="form-control" id="nombre" required>
                        </div>

                        <!-- Campo Email -->
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>

                        <!-- Campo Dirección -->
                        <div class="mb-3">
                            <label for="direccion" class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="direccion" required>
                        </div>

                        <!-- Campo Teléfono -->
                        <div class="mb-3">
                            <label for="telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="telefono" required>
                        </div>
                    </form>
                </div>

                <!-- Pie del modal con botones -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL DE CONFIRMACIÓN DE ELIMINACIÓN ========== -->
    <div class="modal fade" id="modalEliminar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje de confirmación con nombre del cliente -->
                    <p class="mb-0">¿Desea eliminar al cliente <strong id="nombreClienteEliminar"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Sí, Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL DE ÉXITO ========== -->
    <div class="modal fade" id="modalExito" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Éxito</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje dinámico de éxito (se cambia desde JavaScript) -->
                    <p class="mb-0" id="mensajeExito"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL DE ERROR ========== -->
    <div class="modal fade" id="modalError" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Error</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje dinámico de error (se cambia desde JavaScript) -->
                    <p class="mb-0" id="mensajeError"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>



    <!-- ========== JAVASCRIPT PRINCIPAL ========== -->
    <script>
        // IIFE (Immediately Invoked Function Expression) para encapsular el código
        (function () {
            // ========== VARIABLES GLOBALES ==========
            let clientes = [];              // Array para almacenar todos los clientes
            let clientesFiltrados = [];     // Array para almacenar clientes filtrados por búsqueda
            let filaSeleccionada = null;    // Índice de la fila seleccionada en la tabla
            let modoEdicion = false;        // Bandera para saber si estamos editando o agregando
            let modalCliente;               // Instancia del modal de cliente

            // ========== FUNCIÓN PARA FILTRAR CLIENTES POR BÚSQUEDA ==========
            function filtrarClientes(textoBusqueda) {
                // Si no hay texto de búsqueda, mostrar todos
                if (!textoBusqueda || textoBusqueda.trim() === "") {
                    clientesFiltrados = clientes;
                    return;
                }

                // Convertir a minúsculas para búsqueda case-insensitive
                let busqueda = textoBusqueda.toLowerCase().trim();

                // Filtrar clientes que coincidan en nombre
                clientesFiltrados = clientes.filter(cli => {
                    let nombre = cli.nombre.toLowerCase();
                    return nombre.includes(busqueda);
                });
            }

            // ========== FUNCIÓN PARA RENDERIZAR LA TABLA ==========
            function renderTabla() {
                let tbody = $("#tablaClientes tbody");
                tbody.empty(); // Limpiar el contenido actual de la tabla

                // Determinar qué array mostrar (filtrado o completo)
                let datosAMostrar = clientesFiltrados;

                // Si no hay clientes, mostrar mensaje
                if (datosAMostrar.length === 0) {
                    let mensaje = clientes.length === 0
                        ? "No hay clientes registrados"
                        : "No se encontraron clientes con ese criterio de búsqueda";
                    tbody.append(`
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        ${mensaje}
                                    </td>
                                </tr>
                            `);
                    return;
                }

                // Recorrer el array de clientes y crear filas
                datosAMostrar.forEach((cli, i) => {
                    // Buscar el índice real en el array original
                    let indiceReal = clientes.findIndex(c => c.idCliente === cli.idCliente);
                    tbody.append(`
                                <tr data-index="${indiceReal}">
                                    <td>${cli.nombre}</td>
                                    <td>${cli.email}</td>
                                    <td>${cli.direccion}</td>
                                    <td>${cli.telefono}</td>
                                    <td>${new Date(cli.creaccion).toLocaleDateString()}</td>
                                </tr>
                            `);
                });

                // Agregar evento click a cada fila de la tabla
                $("#tablaClientes tbody tr").click(function () {
                    // No hacer nada si es la fila de "no hay clientes"
                    if ($(this).find('td').length === 1) return;

                    // Remover la clase de selección de todas las filas
                    $("#tablaClientes tbody tr").removeClass("table-primary");
                    // Agregar clase de selección a la fila clickeada
                    $(this).addClass("table-primary");
                    // Guardar el índice de la fila seleccionada
                    filaSeleccionada = $(this).data("index");

                    // Habilitar los botones de Editar y Eliminar
                    $("#btnEditar, #btnEliminar").prop("disabled", false);
                });
            }

            // ========== FUNCIÓN PARA CARGAR CLIENTES DESDE LA API ==========
            function cargarClientes() {
                $.ajax({
                    url: "/api/Clientes",  // Endpoint de la API
                    method: "GET",
                    success: function (data) {
                        // Mapear los datos recibidos al formato que usamos
                        clientes = data.map(cli => ({
                            idCliente: cli.idCliente,
                            nombre: cli.nombre.trim(),
                            email: cli.email.trim(),
                            direccion: cli.direccion.trim(),
                            telefono: cli.telefono.trim(),
                            creaccion: cli.creaccion,
                            estado: cli.estado
                        }));
                        clientesFiltrados = clientes; // Inicializar filtrados con todos
                        renderTabla(); // Actualizar la tabla con los datos
                    },
                    error: function (err) {
                        console.error("Error cargando clientes:", err);
                        alert("Error al cargar clientes");
                    }
                });
            }

            // ========== FUNCIÓN PARA LIMPIAR EL FORMULARIO ==========
            function limpiarFormulario() {
                $("#formCliente")[0].reset();  // Reset del formulario HTML
                $("#idCliente").val("");       // Limpiar el ID oculto
            }

            // ========== FUNCIÓN PARA ABRIR MODAL EN MODO "NUEVO" ==========
            function abrirModalNuevo() {
                modoEdicion = false;  // Indicar que estamos agregando
                limpiarFormulario();  // Limpiar el formulario
                // Configurar el título y botón para "Nuevo"
                $("#modalTitulo").text("Nuevo Cliente");
                $("#btnGuardar").text("Guardar").removeClass("btn-warning").addClass("btn-primary");
                modalCliente.show();  // Mostrar el modal
            }

            // ========== FUNCIÓN PARA ABRIR MODAL EN MODO "EDITAR" ==========
            function abrirModalEditar() {
                // Validar que hay una fila seleccionada
                if (filaSeleccionada === null) {
                    alert("Seleccione un cliente para editar");
                    return;
                }

                modoEdicion = true;  // Indicar que estamos editando
                let cli = clientes[filaSeleccionada];  // Obtener datos del cliente

                // Llenar el formulario con los datos del cliente
                $("#idCliente").val(cli.idCliente);
                $("#nombre").val(cli.nombre);
                $("#email").val(cli.email);
                $("#direccion").val(cli.direccion);
                $("#telefono").val(cli.telefono);

                // Configurar el título y botón para "Editar"
                $("#modalTitulo").text("Editar Cliente");
                $("#btnGuardar").text("Guardar Cambios").removeClass("btn-primary").addClass("btn-warning");
                modalCliente.show();  // Mostrar el modal
            }

            // ========== FUNCIÓN PARA GUARDAR CLIENTE (AGREGAR O EDITAR) ==========
            function guardarCliente() {
                // Validar que el formulario esté completo
                if (!$("#formCliente")[0].checkValidity()) {
                    $("#formCliente")[0].reportValidity();
                    return;
                }

                // Recopilar datos del formulario
                let datos = {
                    nombre: $("#nombre").val(),
                    email: $("#email").val(),
                    direccion: $("#direccion").val(),
                    telefono: $("#telefono").val(),
                    creaccion: modoEdicion ? clientes[filaSeleccionada].creaccion : new Date().toISOString(),
                    estado: true
                };

                // ===== MODO EDICIÓN (PUT) =====
                if (modoEdicion) {
                    datos.idCliente = Number($("#idCliente").val());
                    $.ajax({
                        url: `/api/Clientes/${datos.idCliente}`,
                        method: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify(datos),
                        success: function () {
                            modalCliente.hide();  // Ocultar modal del formulario
                            // Mostrar modal de éxito
                            $("#mensajeExito").text("El cliente fue actualizado exitosamente.");
                            let modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
                            modalExito.show();
                            // Recargar datos y resetear selección
                            cargarClientes();
                            filaSeleccionada = null;
                            $("#btnEditar, #btnEliminar").prop("disabled", true);
                        },
                        error: function (err) {
                            console.error(err);
                            modalCliente.hide();  // Ocultar modal del formulario
                            // Mostrar modal de error
                            $("#mensajeError").text("No se pudo actualizar el cliente. Por favor, intente nuevamente.");
                            let modalError = new bootstrap.Modal(document.getElementById('modalError'));
                            modalError.show();
                        }
                    });
                }
                // ===== MODO AGREGAR (POST) =====
                else {
                    datos.idCliente = 0;  // ID 0 para nuevo registro
                    $.ajax({
                        url: "/api/Clientes",
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(datos),
                        success: function () {
                            modalCliente.hide();  // Ocultar modal del formulario
                            // Mostrar modal de éxito
                            $("#mensajeExito").text("El cliente fue agregado exitosamente.");
                            let modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
                            modalExito.show();
                            // Recargar datos
                            cargarClientes();
                        },
                        error: function (err) {
                            console.error(err);
                            modalCliente.hide();  // Ocultar modal del formulario
                            // Most
                            // Mostrar modal de error
                            $("#mensajeError").text("No se pudo agregar el cliente. Por favor, intente nuevamente.");
                            let modalError = new bootstrap.Modal(document.getElementById('modalError'));
                            modalError.show();
                        }
                    });
                }
            }

            // ========== FUNCIÓN PARA MOSTRAR MODAL DE CONFIRMACIÓN DE ELIMINACIÓN ==========
            function eliminarCliente() {
                // Validar que hay una fila seleccionada
                if (filaSeleccionada === null) {
                    alert("Seleccione un cliente para eliminar");
                    return;
                }

                let cli = clientes[filaSeleccionada];

                // Mostrar el nombre del cliente en el modal de confirmación
                $("#nombreClienteEliminar").text(cli.nombre);
                let modalEliminar = new bootstrap.Modal(document.getElementById('modalEliminar'));
                modalEliminar.show();
            }

            // ========== FUNCIÓN PARA CONFIRMAR Y EJECUTAR LA ELIMINACIÓN ==========
            function confirmarEliminacion() {
                let cli = clientes[filaSeleccionada];
                let modalEliminar = bootstrap.Modal.getInstance(document.getElementById('modalEliminar'));

                // Llamada DELETE a la API
                $.ajax({
                    url: `/api/Clientes/${cli.idCliente}`,
                    method: "DELETE",
                    success: function () {
                        modalEliminar.hide();  // Ocultar modal de confirmación
                        // Mostrar modal de éxito
                        $("#mensajeExito").text("El cliente fue eliminado exitosamente.");
                        let modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
                        modalExito.show();
                        // Recargar datos y resetear selección
                        cargarClientes();
                        filaSeleccionada = null;
                        $("#btnEditar, #btnEliminar").prop("disabled", true);
                    },
                    error: function (err) {
                        console.error(err);
                        modalEliminar.hide();  // Ocultar modal de confirmación
                        // Mostrar modal de error
                        $("#mensajeError").text("No se pudo eliminar el cliente. Por favor, intente nuevamente.");
                        let modalError = new bootstrap.Modal(document.getElementById('modalError'));
                        modalError.show();
                    }
                });
            }

            // ========== INICIALIZACIÓN CUANDO EL DOCUMENTO ESTÁ LISTO ==========
            $(document).ready(function () {
                // Crear instancia del modal de cliente
                modalCliente = new bootstrap.Modal(document.getElementById('modalCliente'));

                // Cargar clientes al iniciar
                cargarClientes();

                // ===== ASIGNAR EVENTOS A LOS BOTONES =====
                $("#btnNuevo").click(abrirModalNuevo);                    // Botón "Nuevo Cliente"
                $("#btnEditar").click(abrirModalEditar);                  // Botón "Editar"
                $("#btnEliminar").click(eliminarCliente);               // Botón "Eliminar"
                $("#btnGuardar").click(guardarCliente);                 // Botón "Guardar" en el modal
                $("#btnConfirmarEliminar").click(confirmarEliminacion);   // Botón "Sí, Eliminar"

                // ===== LIMPIAR FORMULARIO AL CERRAR EL MODAL =====
                $('#modalCliente').on('hidden.bs.modal', function () {
                    limpiarFormulario();
                });

                // ===== BÚSQUEDA EN TIEMPO REAL =====
                $("#inputBuscar").on("input", function () {
                    let textoBusqueda = $(this).val();
                    filtrarClientes(textoBusqueda);
                    renderTabla();
                    // Resetear selección al buscar
                    filaSeleccionada = null;
                    $("#btnEditar, #btnEliminar").prop("disabled", true);
                });

                // ===== LIMPIAR BÚSQUEDA =====
                $("#btnLimpiarBusqueda").click(function () {
                    $("#inputBuscar").val("");
                    filtrarClientes("");
                    renderTabla();
                    // Resetear selección
                    filaSeleccionada = null;
                    $("#btnEditar, #btnEliminar").prop("disabled", true);
                });
            });
        })();
    </script>
</body>
</html>