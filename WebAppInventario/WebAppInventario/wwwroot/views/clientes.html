<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Clientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .contenedor {
            display: flex;
            gap: 20px;
        }

        .formulario {
            flex: 1;
        }

        .tabla-clientes {
            flex: 2;
            max-height: 500px;
            overflow-y: auto;
        }

        .botones-crud {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .tabla-desactivada {
            pointer-events: none;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <h2 class="mb-3">Gestión de Clientes</h2>

        <div class="contenedor">
            <!-- Formulario lado izquierdo -->
            <div class="formulario">
                <form id="formCliente">
                    <input type="hidden" id="idCliente">
                    <div class="mb-2">
                        <input type="text" class="form-control" id="nombre" placeholder="Nombre" required disabled>
                    </div>
                    <div class="mb-2">
                        <input type="email" class="form-control" id="email" placeholder="Email" required disabled>
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="direccion" placeholder="Dirección" required disabled>
                    </div>
                    <div class="mb-2">
                        <input type="tel" class="form-control" id="telefono" placeholder="Teléfono" required disabled>
                    </div>
                </form>
            </div>

            <!-- Tabla lado derecho información de cliente -->
            <div class="tabla-clientes">
                <table class="table table-dark table-striped" id="tablaClientes">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Dirección</th>
                            <th>Teléfono</th>
                            <th>Fecha Creación</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Datos de clientes -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Botones CRUD debajo de la tabla -->
        <div class="botones-crud">
            <button id="btnAgregar" class="btn btn-primary">Agregar</button>
            <button id="btnEditar" class="btn btn-warning">Editar</button>
            <button id="btnEliminar" class="btn btn-danger">Eliminar</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        (function () {
            let clientes = [];
            let filaSeleccionada = null;
            let modo = 'normal'; // Estados: 'normal', 'agregar', 'editar'

            function renderTabla() {
                let tbody = $("#tablaClientes tbody");
                tbody.empty();
                clientes.forEach((cli, i) => {
                    tbody.append(`
                                    <tr data-index="${i}">
                                        <td>${cli.nombre}</td>
                                        <td>${cli.email}</td>
                                        <td>${cli.direccion}</td>
                                        <td>${cli.telefono}</td>
                                        <td>${new Date(cli.creaccion).toLocaleDateString()}</td>
                                    </tr>
                                `);
                });

                // Solo agregar el evento click si estamos en modo normal
                if (modo === 'normal') {
                    $("#tablaClientes tbody tr").click(function () {
                        $("#tablaClientes tbody tr").removeClass("table-primary");
                        $(this).addClass("table-primary");
                        filaSeleccionada = $(this).data("index");

                        // Llenar formulario
                        let cli = clientes[filaSeleccionada];
                        $("#idCliente").val(cli.idCliente);
                        $("#nombre").val(cli.nombre);
                        $("#email").val(cli.email);
                        $("#direccion").val(cli.direccion);
                        $("#telefono").val(cli.telefono);
                    });
                }
            }

            function cargarClientes() {
                $.ajax({
                    url: "/api/Clientes",
                    method: "GET",
                    success: function (data) {
                        clientes = data.map(cli => ({
                            idCliente: cli.idCliente,
                            nombre: cli.nombre.trim(),
                            email: cli.email.trim(),
                            direccion: cli.direccion.trim(),
                            telefono: cli.telefono.trim(),
                            creaccion: cli.creaccion,
                            estado: cli.estado
                        }));
                        renderTabla();
                    },
                    error: function (err) {
                        console.error("Error cargando clientes:", err);
                    }
                });
            }

            function activarModoAgregar() {
                modo = 'agregar';
                $("#btnAgregar").text("Guardar").removeClass("btn-primary").addClass("btn-success");
                $("#btnEditar").text("Cancelar").removeClass("btn-warning").addClass("btn-secondary");
                $("#btnEliminar").prop("disabled", true);
                $("#tablaClientes").addClass("tabla-desactivada");
                $("#formCliente")[0].reset();
                filaSeleccionada = null;
                // Habilitar campos del formulario
                $("#nombre, #email, #direccion, #telefono").prop("disabled", false);
                renderTabla(); // Re-render para quitar eventos de click
            }

            function activarModoEditar() {
                if (filaSeleccionada === null) {
                    alert("Seleccione un cliente para editar");
                    return;
                }
                modo = 'editar';
                $("#btnAgregar").text("Guardar Cambios").removeClass("btn-primary").addClass("btn-success");
                $("#btnEditar").text("Cancelar").removeClass("btn-warning").addClass("btn-secondary");
                $("#btnEliminar").prop("disabled", true);
                $("#tablaClientes").addClass("tabla-desactivada");
                // Habilitar campos del formulario
                $("#nombre, #email, #direccion, #telefono").prop("disabled", false);
                renderTabla(); // Re-render para quitar eventos de click
            }

            function desactivarModo() {
                modo = 'normal';
                $("#btnAgregar").text("Agregar").removeClass("btn-success").addClass("btn-primary");
                $("#btnEditar").text("Editar").removeClass("btn-secondary").addClass("btn-warning");
                $("#btnEliminar").prop("disabled", false);
                $("#tablaClientes").removeClass("tabla-desactivada");
                $("#formCliente")[0].reset();
                filaSeleccionada = null;
                // Deshabilitar campos del formulario
                $("#nombre, #email, #direccion, #telefono").prop("disabled", true);
                renderTabla(); // Re-render para restaurar eventos
            }

            $(document).ready(function () {
                cargarClientes();

                // Botón Agregar / Guardar
                $("#btnAgregar").click(function () {
                    if (modo === 'agregar') {
                        // Guardar nuevo cliente
                        if (!$("#formCliente")[0].checkValidity()) {
                            $("#formCliente")[0].reportValidity();
                            return;
                        }
                        let nuevo = {
                            idCliente: 0,
                            nombre: $("#nombre").val(),
                            email: $("#email").val(),
                            direccion: $("#direccion").val(),
                            telefono: $("#telefono").val(),
                            creaccion: new Date().toISOString(),
                            estado: true
                        };
                        $.ajax({
                            url: "/api/Clientes",
                            method: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(nuevo),
                            success: function () {
                                alert("Cliente agregado");
                                cargarClientes();
                                desactivarModo();
                            },
                            error: function (err) { console.error(err); }
                        });
                    } else if (modo === 'editar') {
                        // Guardar cambios en edición
                        if (!$("#formCliente")[0].checkValidity()) {
                            $("#formCliente")[0].reportValidity();
                            return;
                        }
                        let actualizar = {
                            idCliente: Number($("#idCliente").val()),
                            nombre: $("#nombre").val(),
                            email: $("#email").val(),
                            direccion: $("#direccion").val(),
                            telefono: $("#telefono").val(),
                            creaccion: clientes[filaSeleccionada].creaccion, // Mantener la fecha original
                            estado: true
                        };
                        $.ajax({
                            url: `/api/Clientes/${actualizar.idCliente}`,
                            method: "PUT",
                            contentType: "application/json",
                            data: JSON.stringify(actualizar),
                            success: function () {
                                alert("Cliente actualizado");
                                cargarClientes();
                                desactivarModo();
                            },
                            error: function (err) { console.error(err); }
                        });
                    } else {
                        // Inicia modo agregar
                        activarModoAgregar();
                    }
                });

                // Botón Editar / Cancelar
                $("#btnEditar").click(function () {
                    if (modo === 'agregar' || modo === 'editar') {
                        // Cancelar
                        desactivarModo();
                    } else {
                        // Inicia modo editar
                        activarModoEditar();
                    }
                });

                // Eliminar cliente
                $("#btnEliminar").click(function () {
                    if (modo !== 'normal') return; // Deshabilitado en modos agregar/editar
                    if (filaSeleccionada === null) {
                        alert("Seleccione un cliente para eliminar");
                        return;
                    }
                    let id = Number($("#idCliente").val());
                    const nombreCliente = $("#nombre").val();
                    if (confirm(`¿Desea eliminar a ${nombreCliente}?`)) {
                        $.ajax({
                            url: `/api/Clientes/${id}`,
                            method: "DELETE",
                            success: function () {
                                alert("Cliente eliminado");
                                cargarClientes();
                                $("#formCliente")[0].reset();
                                filaSeleccionada = null;
                            },
                            error: function (err) { console.error(err); }
                        });
                    }
                });
            });
        })();
    </script>
</body>
</html>
