<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Inventario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .contenedor {
            display: flex;
            gap: 20px;
        }

        .formulario {
            flex: 1;
        }

        .tabla-inventario {
            flex: 2;
            max-height: 500px;
            overflow-y: auto;
        }

        .botones-crud {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .tabla-desactivada {
            pointer-events: none;
            opacity: 0.5;
        }

        .seccion-producto {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        .seccion-inventario {
            border: 1px solid #ccc;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <h2 class="mb-3">Gestión de Inventario</h2>

        <div class="contenedor">
            <!-- Formulario lado izquierdo -->
            <div class="formulario">
                <form id="formInventario">
                    <input type="hidden" id="idInventario">
                    <input type="hidden" id="idProducto">

                    <!-- Sección Producto -->
                    <div class="seccion-producto">
                        <h5>Producto</h5>
                        <div class="mb-2">
                            <label for="idProveedor" class="form-label">Proveedor</label>
                            <select id="idProveedor" class="form-select" required disabled>
                                <option value="">Seleccione un proveedor</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label for="idCategoria" class="form-label">Categoría</label>
                            <select id="idCategoria" class="form-select" required disabled>
                                <option value="">Seleccione una categoría</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control" id="codigo" placeholder="Código" required disabled>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control" id="nombreProducto" placeholder="Nombre Producto" required disabled>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control" id="descripcion" placeholder="Descripción" disabled>
                        </div>
                        <div class="mb-2">
                            <input type="date" class="form-control" id="fechaProd" placeholder="Fecha Producción" required disabled>
                        </div>
                        <div class="mb-2">
                            <input type="date" class="form-control" id="fechaVenc" placeholder="Fecha Vencimiento" required disabled>
                        </div>
                    </div>

                    <!-- Sección Inventario -->
                    <div class="seccion-inventario">
                        <h5>Inventario</h5>
                        <div class="mb-2">
                            <input type="number" step="0.01" class="form-control" id="precio" placeholder="Precio" required disabled>
                        </div>
                        <div class="mb-2">
                            <input type="number" step="0.01" class="form-control" id="costo" placeholder="Costo" required disabled>
                        </div>
                        <div class="mb-2">
                            <input type="number" class="form-control" id="cantidad" placeholder="Cantidad" required disabled>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control" id="ubicacion" placeholder="Ubicación" required disabled>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Tabla lado derecho información de inventario -->
            <div class="tabla-inventario">
                <table class="table table-dark table-striped" id="tablaInventario">
                    <thead>
                        <tr>
                            <th>Nombre Producto</th>
                            <th>Precio</th>
                            <th>Costo</th>
                            <th>Cantidad</th>
                            <th>Ubicación</th>
                            <th>Última Actualización</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Datos de inventario -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Botones CRUD debajo de la tabla -->
        <div class="botones-crud">
            <button id="btnAgregar" class="btn btn-primary">Agregar</button>
            <button id="btnEditar" class="btn btn-warning">Editar</button>
            <button id="btnEliminar" class="btn btn-danger">Eliminar</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        (function () {
            let inventarios = [];
            let proveedores = [];
            let categorias = [];
            let filaSeleccionada = null;
            let modo = 'normal'; // Estados: 'normal', 'agregar', 'editar'

            function cargarProveedores() {
                $.ajax({
                    url: "/api/Proveedores",
                    method: "GET",
                    success: function (data) {
                        proveedores = data;
                        let select = $("#idProveedor");
                        select.empty();
                        select.append('<option value="">Seleccione un proveedor</option>');
                        proveedores.forEach(prov => {
                            select.append(`<option value="${prov.idProveedor}">${prov.nombre.trim()}</option>`);
                        });
                    },
                    error: function (err) {
                        console.error("Error cargando proveedores:", err);
                    }
                });
            }

            function cargarCategorias() {
                $.ajax({
                    url: "/api/Categorias", // Asumiendo API para categorias
                    method: "GET",
                    success: function (data) {
                        categorias = data;
                        let select = $("#idCategoria");
                        select.empty();
                        select.append('<option value="">Seleccione una categoría</option>');
                        categorias.forEach(cat => {
                            select.append(`<option value="${cat.idCategoria}">${cat.nombre.trim()}</option>`); // Asumiendo campo nombre
                        });
                    },
                    error: function (err) {
                        console.error("Error cargando categorias:", err);
                    }
                });
            }

            function renderTabla() {
                let tbody = $("#tablaInventario tbody");
                tbody.empty();
                inventarios.forEach((inv, i) => {
                    tbody.append(`
                                    <tr data-index="${i}">
                                        <td>${inv.productoNombre}</td>
                                        <td>${inv.precio}</td>
                                        <td>${inv.costo}</td>
                                        <td>${inv.cantidad}</td>
                                        <td>${inv.ubicacion}</td>
                                        <td>${inv.ultimaActualizacion}</td>
                                    </tr>
                                `);
                });

                // Solo agregar el evento click si estamos en modo normal
                if (modo === 'normal') {
                    $("#tablaInventario tbody tr").click(function () {
                        $("#tablaInventario tbody tr").removeClass("table-primary");
                        $(this).addClass("table-primary");
                        filaSeleccionada = $(this).data("index");

                        // Llenar formulario
                        let inv = inventarios[filaSeleccionada];
                        $("#idInventario").val(inv.idInventario);
                        $("#idProducto").val(inv.idProducto);
                        $("#idProveedor").val(inv.idProveedor || ''); // Asumiendo que tienes idProveedor en el inventario o producto
                        $("#idCategoria").val(inv.idCategoria || '');
                        $("#codigo").val(inv.productoCodigo);
                        $("#nombreProducto").val(inv.productoNombre);
                        $("#descripcion").val(inv.descripcion || '');
                        $("#fechaProd").val(inv.productoFechaProd);
                        $("#fechaVenc").val(inv.productoFechaVenc);
                        $("#precio").val(inv.precio);
                        $("#costo").val(inv.costo);
                        $("#cantidad").val(inv.cantidad);
                        $("#ubicacion").val(inv.ubicacion);
                    });
                }
            }

            function cargarInventarios() {
                $.ajax({
                    url: "/api/Inventario",
                    method: "GET",
                    success: function (data) {
                        inventarios = data.map(inv => ({
                            idInventario: inv.idInventario,
                            idProducto: inv.idProducto,
                            precio: inv.precio,
                            costo: inv.costo,
                            cantidad: inv.cantidad,
                            ubicacion: inv.ubicacion.trim(),
                            ultimaActualizacion: inv.ultimaActualizacion,
                            productoNombre: inv.productoNombre.trim(),
                            productoCodigo: inv.productoCodigo.trim(),
                            productoEstado: inv.productoEstado,
                            productoFechaProd: inv.productoFechaProd,
                            productoFechaVenc: inv.productoFechaVenc,
                            productocategoria: inv.productocategoria.trim(),
                            productoproveedor: inv.productoproveedor.trim(),
                            descripcion: inv.descripcion || '', // Asumiendo que tienes descripcion en el producto
                            idProveedor: inv.idProveedor || '', // Asumiendo campos adicionales
                            idCategoria: inv.idCategoria || ''
                        }));
                        renderTabla();
                    },
                    error: function (err) {
                        console.error("Error cargando inventarios:", err);
                    }
                });
            }

            function activarModoAgregar() {
                modo = 'agregar';
                $("#btnAgregar").text("Guardar").removeClass("btn-primary").addClass("btn-success");
                $("#btnEditar").text("Cancelar").removeClass("btn-warning").addClass("btn-secondary");
                $("#btnEliminar").prop("disabled", true);
                $("#tablaInventario").addClass("tabla-desactivada");
                $("#formInventario")[0].reset();
                filaSeleccionada = null;
                // Habilitar campos del formulario
                $("#idProveedor, #idCategoria, #codigo, #nombreProducto, #descripcion, #fechaProd, #fechaVenc, #precio, #costo, #cantidad, #ubicacion").prop("disabled", false);
                renderTabla(); // Re-render para quitar eventos de click
            }

            function activarModoEditar() {
                if (filaSeleccionada === null) {
                    alert("Seleccione un inventario para editar");
                    return;
                }
                modo = 'editar';
                $("#btnAgregar").text("Guardar Cambios").removeClass("btn-primary").addClass("btn-success");
                $("#btnEditar").text("Cancelar").removeClass("btn-warning").addClass("btn-secondary");
                $("#btnEliminar").prop("disabled", true);
                $("#tablaInventario").addClass("tabla-desactivada");
                // Habilitar campos del formulario
                $("#idProveedor, #idCategoria, #codigo, #nombreProducto, #descripcion, #fechaProd, #fechaVenc, #precio, #costo, #cantidad, #ubicacion").prop("disabled", false);
                renderTabla(); // Re-render para quitar eventos de click
            }

            function desactivarModo() {
                modo = 'normal';
                $("#btnAgregar").text("Agregar").removeClass("btn-success").addClass("btn-primary");
                $("#btnEditar").text("Editar").removeClass("btn-secondary").addClass("btn-warning");
                $("#btnEliminar").prop("disabled", false);
                $("#tablaInventario").removeClass("tabla-desactivada");
                $("#formInventario")[0].reset();
                filaSeleccionada = null;
                // Deshabilitar campos del formulario
                $("#idProveedor, #idCategoria, #codigo, #nombreProducto, #descripcion, #fechaProd, #fechaVenc, #precio, #costo, #cantidad, #ubicacion").prop("disabled", true);
                renderTabla(); // Re-render para restaurar eventos
            }

            $(document).ready(function () {
                cargarProveedores();
                cargarCategorias();
                cargarInventarios();

                // Botón Agregar / Guardar
                $("#btnAgregar").click(function () {
                    if (modo === 'agregar') {
                        // Guardar nuevo producto primero
                        if (!$("#formInventario")[0].checkValidity()) {
                            $("#formInventario")[0].reportValidity();
                            return;
                        }
                        let nuevoProducto = {
                            idProducto: 0,
                            idProveedor: Number($("#idProveedor").val()),
                            idCategoria: Number($("#idCategoria").val()),
                            codigo: $("#codigo").val(),
                            nombre: $("#nombreProducto").val(),
                            descripcion: $("#descripcion").val(),
                            estado: true,
                            fechaProd: $("#fechaProd").val(),
                            fechaVenc: $("#fechaVenc").val()
                        };
                        $.ajax({
                            url: "/api/Productos",
                            method: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(nuevoProducto),
                            success: function (productoCreado) {
                                let idProductoNuevo = productoCreado.idProducto; // Asumiendo que devuelve el ID
                                // Ahora crear inventario
                                let nuevoInventario = {
                                    idInventario: 0,
                                    idProducto: idProductoNuevo,
                                    precio: Number($("#precio").val()),
                                    costo: Number($("#costo").val()),
                                    cantidad: Number($("#cantidad").val()),
                                    ubicacion: $("#ubicacion").val(),
                                    ultimaActualizacion: new Date().toISOString().split('T')[0] // Fecha actual
                                };
                                $.ajax({
                                    url: "/api/Inventarios",
                                    method: "POST",
                                    contentType: "application/json",
                                    data: JSON.stringify(nuevoInventario),
                                    success: function () {
                                        alert("Inventario agregado");
                                        cargarInventarios();
                                        desactivarModo();
                                    },
                                    error: function (err) { console.error("Error creando inventario:", err); }
                                });
                            },
                            error: function (err) { console.error("Error creando producto:", err); }
                        });
                    } else if (modo === 'editar') {
                        // Guardar cambios (actualizar producto e inventario)
                        if (!$("#formInventario")[0].checkValidity()) {
                            $("#formInventario")[0].reportValidity();
                            return;
                        }
                        let actualizarProducto = {
                            idProducto: Number($("#idProducto").val()),
                            idProveedor: Number($("#idProveedor").val()),
                            idCategoria: Number($("#idCategoria").val()),
                            codigo: $("#codigo").val(),
                            nombre: $("#nombreProducto").val(),
                            descripcion: $("#descripcion").val(),
                            estado: true,
                            fechaProd: $("#fechaProd").val(),
                            fechaVenc: $("#fechaVenc").val()
                        };
                        $.ajax({
                            url: `/api/Productos/${actualizarProducto.idProducto}`,
                            method: "PUT",
                            contentType: "application/json",
                            data: JSON.stringify(actualizarProducto),
                            success: function () {
                                let actualizarInventario = {
                                    idInventario: Number($("#idInventario").val()),
                                    idProducto: Number($("#idProducto").val()),
                                    precio: Number($("#precio").val()),
                                    costo: Number($("#costo").val()),
                                    cantidad: Number($("#cantidad").val()),
                                    ubicacion: $("#ubicacion").val(),
                                    ultimaActualizacion: new Date().toISOString().split('T')[0]
                                };
                                $.ajax({
                                    url: `/api/Inventarios/${actualizarInventario.idInventario}`,
                                    method: "PUT",
                                    contentType: "application/json",
                                    data: JSON.stringify(actualizarInventario),
                                    success: function () {
                                        alert("Inventario actualizado");
                                        cargarInventarios();
                                        desactivarModo();
                                    },
                                    error: function (err) { console.error("Error actualizando inventario:", err); }
                                });
                            },
                            error: function (err) { console.error("Error actualizando producto:", err); }
                        });
                    } else {
                        // Inicia modo agregar
                        activarModoAgregar();
                    }
                });

                // Botón Editar / Cancelar
                $("#btnEditar").click(function () {
                    if (modo === 'agregar' || modo === 'editar') {
                        // Cancelar
                        desactivarModo();
                    } else {
                        // Inicia modo editar
                        activarModoEditar();
                    }
                });

                // Eliminar inventario
                $("#btnEliminar").click(function () {
                    if (modo !== 'normal') return; // Deshabilitado en modos agregar/editar
                    if (filaSeleccionada === null) {
                        alert("Seleccione un inventario para eliminar");
                        return;
                    }
                    let id = Number($("#idInventario").val());
                    const nombreProducto = $("#nombreProducto").val();
                    if (confirm(`¿Desea eliminar el inventario de ${nombreProducto}?`)) {
                        $.ajax({
                            url: `/api/Inventarios/${id}`,
                            method: "DELETE",
                            success: function () {
                                alert("Inventario eliminado");
                                cargarInventarios();
                                $("#formInventario")[0].reset();
                                filaSeleccionada = null;
                            },
                            error: function (err) { console.error(err); }
                        });
                    }
                });
            });
        })();
    </script>
</body>
</html>